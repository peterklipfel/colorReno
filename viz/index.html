<!doctype html>
<html>
	<head>
		<title>Many Points with  leaflet Canvas</title>
		<meta charset="utf-8">
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
		<style>
			html, body { margin: 0; padding: 0; }
			#map { position: absolute; height: 100%; width: 100%; background-color: #333; }
		</style>
		<script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
		<script src="L.CanvasOverlay.js"></script>
	</head>
	<body>
		<div id="map"></div>
		<script src="data.js" charset="utf-8"></script>
		
		<script>
			var leafletMap = L.map('map').setView([39.525,-119.825], 11);
			L.tileLayer("http://{s}.sm.mapstack.stamen.com/(toner-lite,$fff[difference],$fff[@23],$fff[hsl-saturation@20])/{z}/{x}/{y}.png").addTo(leafletMap);
			
			var raf = null, _T = null;
			var ctx = null, lco = null, lcp = null;
			
			L.canvasOverlay()
				.drawing(drawingOnCanvas)
				.addTo(leafletMap);
			
			function drawingOnCanvas(canvasOverlay, params) {
				ctx = params.canvas.getContext('2d');
				lco = canvasOverlay;
				lcp = params;
				_T = Date.now();
				
				if(raf) {
					clearAnimationFrame(raf);
					raf = null;
				}
				
				draw();
			};
			
			function opacity(percent) {
				if(percent < .2) return percent / .2;
				return 1 - percent;
			}
			
			function draw() {
				raf = requestAnimationFrame(draw);
				
				var T = (Date.now() - _T) / 1000;
				if(T > 15) _T = Date.now();
				
				ctx.clearRect(0, 0, lcp.canvas.width, lcp.canvas.height);
				
				data.map(function(item) {
					if(!lcp.bounds.contains(item.location)) return;
					if(T < item.time) return;
					if(T > item.time + 2) return;
					
					var percent = (T - item.time) / 2;
					
					var dot = lco._map.latLngToContainerPoint(item.location);
					ctx.fillStyle = ["rgba(",item.colors[0].join(','),',', opacity(percent) ,")"].join('');
					
					ctx.beginPath();
					ctx.arc(dot.x, dot.y, 5 / (1.25 - percent), 0, Math.PI * 2);
					ctx.fill();
					ctx.closePath();
				});
			}
		</script>
	</body>
</html>
