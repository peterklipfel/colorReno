<!doctype html>
<html>
	<head>
		<title>Many Points with  leaflet Canvas</title>
		<meta charset="utf-8">
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
		<style>
			html, body { margin: 0; padding: 0; }
			#map { position: absolute; height: 100%; width: 100%; background-color: #333; }
			#out { position: absolute; left: 0; bottom: 0; color: white; font-size: 2em; }
		</style>
		<script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
		<script src="L.CanvasOverlay.js"></script>
	</head>
	<body>
		<div id="map"></div>
		<div id="out"></div>
		
		<script src="data.js" charset="utf-8"></script>
		<script>
			function distance(input, target) {
				return Math.sqrt(
					input.reduce(function(o,c,i) {
						return o + Math.pow(input[i] - target[i], 2);
					}, 0)
				);
			}
			
			function sd(input, mu) {
				if(typeof mu === 'undefined') {
					mu = input.reduce(function(o,c) { return o + c; }, 0) / input.length;
				}
				
				return Math.sqrt(
					input.reduce(function(o,c) {
						return o + Math.pow(c - mu, 2);
					}, 0) / input.length
				);
			}
			
			function isNotGrayscale(color) {
				return sd(color) > 5;
			}
			function isNotSkyBlue(color) {
				return distance(color, [54,108,162]) > 200;
			}
			
			function normalizeTime(time) {
				var off = new Date("2004-11-01T00:00:00Z");
				var max = new Date("2014-04-01T00:00:00Z");
				return (item.time - off) / (max - off);
			}
			
			function normalizeTimeYear(time) {
				time = new Date(time.setYear(1990));
				
				var off = new Date("1990-01-01T00:00:00Z");
				var max = new Date("1990-12-31T23:59:59Z");
				return (time - off) / (max - off);
			}
			
			for(var i in data) {
				var item = data[i];
				
				item.time = new Date(item.time);
				item.delay = normalizeTimeYear(item.time);
				
				var colors0 = item.colors;
				var colors1 = colors0.filter(isNotGrayscale);
				var colors2 = colors1.filter(isNotSkyBlue);
				
				item.color = colors2[0] || colors1[0] || colors0[0];
			}
		</script>
		
		<script>
			function drawingOnCanvas(canvasOverlay, params) {
				ctx = params.canvas.getContext('2d');
				lco = canvasOverlay;
				lcp = params;
				_T = Date.now();
				
				if(raf) {
					clearAnimationFrame(raf);
					raf = null;
				}
				
				draw();
			};
			
			function opacity(percent) {
				if(percent < .2) return percent / .2;
				return 1 - percent;
			}
			
			function size(percent) {
				var base = (lcp.zoom - 11) / (18 - 11) * 20 + 5;
				return base / (1.25 - percent);
			}
			
			var out = document.getElementById('out');
			var months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
			
			var length = 60, decay = length / 12 / 4;
			function draw() {
				raf = requestAnimationFrame(draw);
				
				var T = (Date.now() - _T) / 1000;
				if(T > length + decay) _T = Date.now();
				
				var t = T / length * months.length;
				out.innerHTML = months[Math.floor(t)] + ' ' + ((t - Math.floor(t)) * 30).toFixed(0);
				
				ctx.clearRect(0, 0, lcp.canvas.width, lcp.canvas.height);
				
				data.map(function(item) {
					if(!lcp.bounds.contains(item.location)) return;
					if(T < item.delay * length) return;
					if(T > item.delay * length + decay) return;
					
					var percent = (T - item.delay * length) / decay;
					
					var dot = lco._map.latLngToContainerPoint(item.location);
					ctx.fillStyle = ["rgba(",item.color.join(','),',', opacity(percent) ,")"].join('');
					
					ctx.beginPath();
					ctx.arc(dot.x, dot.y, size(percent), 0, Math.PI * 2);
					ctx.fill();
					ctx.closePath();
				});
			}
			
			var leafletMap = L.map('map', {scrollWheelZoom: false}).setView([39.525,-119.825], 12);
			L.tileLayer("http://{s}.sm.mapstack.stamen.com/(toner-lite,$fff[difference],$fff[@23],$fff[hsl-saturation@20])/{z}/{x}/{y}.png").addTo(leafletMap);
			
			var raf = null, _T = null;
			var ctx = null, lco = null, lcp = null;
			
			L.canvasOverlay().drawing(drawingOnCanvas).addTo(leafletMap);
		</script>
	</body>
</html>
